<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هواشناسی ایران</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e293b, #334155, #475569);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .container {
            background-color: #f8fafc;
        }
        .weather-card {
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            animation: fadeIn 0.8s ease-in-out;
            transform-origin: center;
            color: #1a202c; /* Ensure text color is dark and readable */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .forecast-card {
            background: linear-gradient(120deg, #f0f9ff 0%, #e0f2fe 100%);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
        }
        .forecast-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 16px 32px rgba(0,0,0,0.2), 0 0 20px rgba(255, 255, 255, 0.6);
            background: linear-gradient(120deg, #e0f7ff 0%, #c4e9ff 100%);
        }
        .comment-item {
            background-color: #f9fafb;
            border-right: 4px solid #0891b2;
            transition: all 0.3s ease;
        }
        .comment-item:hover {
            background-color: #e2e8f0;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #0ea5e9; border-radius: 3px; }

        .custom-select-trigger {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            cursor: pointer;
        }
        .custom-options-container {
            position: absolute;
            z-index: 10;
            max-height: 250px;
            overflow-y: auto;
            width: 100%;
            background-color: white;
            border: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: none;
            border-radius: 1rem;
            margin-top: 0.5rem;
        }
        .custom-option, .optgroup-label {
            padding: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .custom-option:hover {
            background-color: #f1f5f9;
        }
        .custom-option.selected {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 500;
        }
        .optgroup-label {
            font-weight: 700;
            color: #475569;
            background-color: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-slow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">

<header class="text-center mb-8">
    <h1 class="text-5xl font-extrabold text-white drop-shadow-lg leading-tight animate-pulse-slow">☀️ هواشناسی ایران 🌧️</h1>
    <p class="text-xl text-gray-200 mt-2 font-light">پیش‌بینی آب‌وهوا برای  تمامی استان‌ها و شهرهای مهم ایران</p>
    <p id="datetime" class="text-gray-300 mt-4 text-sm font-light"></p>
</header>

<div class="container rounded-3xl shadow-2xl p-8 w-full max-w-6xl border-t-8 border-cyan-500">
    <div class="flex flex-col md:flex-row justify-center items-center mb-6">
        <div class="custom-select-wrapper w-full md:w-2/3 lg:w-1/2 relative">
            <div id="selectTrigger" class="custom-select-trigger bg-white rounded-full py-4 px-6 text-lg font-medium text-gray-700 focus:outline-none focus:ring-4 focus:ring-blue-300">
                <span id="selectedOptionText">-- انتخاب شهر/استان --</span>
                <i class="fas fa-chevron-down text-gray-400 text-sm mr-2 transition-transform duration-300 transform"></i>
            </div>
            <div id="optionsContainer" class="custom-options-container rounded-2xl">
                <input id="searchInput" type="text" placeholder="جستجوی شهر..." class="w-full p-4 border-b border-gray-200 sticky top-0 bg-white rounded-t-2xl focus:outline-none">
                <div id="optionsList"></div>
            </div>
        </div>
        <input type="hidden" id="citySelect" name="city">
        <button onclick="getWeather()" class="w-full md:w-1/3 lg:w-1/4 mt-4 md:mt-0 md:mr-4 bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white py-4 px-6 rounded-full shadow-lg font-bold transition duration-300 ease-in-out flex items-center justify-center">
            <i class="fas fa-search ml-2"></i> نمایش آب‌وهوا
        </button>
    </div>

    <div id="weatherResult" class="mt-8 hidden opacity-0 transition-opacity duration-500 ease-in-out">
        <h2 class="text-3xl font-bold text-gray-800 mb-4 border-b-4 border-cyan-400 pb-2 text-center">وضعیت فعلی</h2>
        <div id="currentWeather" class="weather-card bg-white p-8 rounded-3xl shadow-xl mb-8 flex flex-col sm:flex-row justify-around items-center space-y-6 sm:space-y-0 text-center relative"></div>

        <h2 class="text-3xl font-bold text-gray-800 mb-4 border-b-4 border-cyan-400 pb-2 text-center">پیش‌بینی ۵ روز آینده</h2>
        <div id="forecast" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"></div>
    </div>

    <div class="mt-12 pt-6 border-t border-gray-300">
        <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">💬 نظرات کاربران</h2>
        <div class="flex flex-col sm:flex-row mb-4">
            <input id="commentInput" type="text" placeholder="نظر خود را وارد کنید..." class="flex-grow p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button onclick="addComment()" class="mt-2 sm:mt-0 sm:mr-2 bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-lg font-semibold transition duration-300 ease-in-out flex items-center justify-center">
                <i class="fas fa-paper-plane ml-2"></i> ارسال
            </button>
        </div>
        <div id="commentsList" class="mt-4 space-y-4 max-h-80 overflow-y-auto pl-2"></div>
    </div>
</div>

<footer class="mt-12 text-gray-300 font-semibold text-center drop-shadow-lg">
    <p>&copy; طراحی: ابوالفضل شاهمیرزایی سال ۱۴۰۴</p>
    <p class="text-sm">این سایت از API WeatherAPI.com استفاده می‌کند ❤️</p>
</footer>

<script>
    // ------------------ تاریخ و ساعت ------------------
    setInterval(() => {
        const now = new Date();
        document.getElementById("datetime").innerText =
            now.toLocaleString('fa-IR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                                         hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }, 1000);

    // ------------------ استان‌ها و شهرهای مهم ------------------
    const iranProvinces = {
        "آذربایجان شرقی":["تبریز","مراغه","مرند","بناب","میانه","اهر","سراب","شبستر","اسکو","جلفا","هشترود"],
        "آذربایجان غربی":["ارومیه","خوی","مهاباد","بوکان","پیرانشهر","میاندوآب","سردشت","ماکو","نقده","سلماس"],
        "اردبیل":["اردبیل","پارس‌آباد","خلخال","مشگین‌شهر","نمین","بیله‌سوار","سرعین","نیر","کوثر"],
        "اصفهان":["اصفهان","کاشان","نجف‌آباد","شهرضا","مبارکه","گلپایگان","نطنز","فولادشهر","شاهین‌شهر","فلاورجان"],
        "البرز":["کرج","طالقان","نظرآباد","هشتگرد","اشتهارد","فردیس","ماهدشت","کمال‌شهر","چهارباغ"],
        "ایلام":["ایلام","دهلران","مهران","آبدانان","ایوان","دره‌شهر","سرابله","بدره","چرداول"],
        "بوشهر":["بوشهر","برازجان","کنگان","جم","گناوه","دشتی","دیر","عسلویه","خارک"],
        "تهران":["تهران","شهریار","اسلام‌شهر","ملارد","پاکدشت","ورامین","دماوند","ری","شمیرانات","پردیس","رباط‌کریم"],
        "چهارمحال و بختیاری":["شهرکرد","بروجن","لردگان","فرخشهر","سامان","هفشجان","کیار","فارسان"],
        "خراسان جنوبی":["بیرجند","قائن","فردوس","سرایان","طبس","نهبندان","بشرویه","سربیشه"],
        "خراسان رضوی":["مشهد","نیشابور","سبزوار","تربت‌حیدریه","بردسکن","فریمان","گناباد","قوچان","کاشمر","خواف"],
        "خراسان شمالی":["بجنورد","شیروان","اسفراین","جاجرم","مانه","فاروج","راز","گرمه"],
        "خوزستان":["اهواز","دزفول","آبادان","اندیمشک","خرمشهر","ماهشهر","بهبهان","مسجدسلیمان","ایذه","شوشتر"],
        "زنجان":["زنجان","ابهر","خرمدره","قیدار","هیدج","سلطانیه","زرین‌رود","ماهنشان"],
        "سمنان":["سمنان","شاهرود","دامغان","گرمسار","مهدی‌شهر","آرادان","سرخه","شهمیرزاد"],
        "سیستان و بلوچستان":["زاهدان","زابل","ایرانشهر","چابهار","خاش","سراوان","نیک‌شهر","کنارک","سرباز"],
        "فارس":["شیراز","مرودشت","جهرم","فسا","لار","کازرون","داراب","اقلید","فیروزآباد","استهبان"],
        "قزوین":["قزوین","تاکستان","الوند","محمدیه","آبیک","بویین‌زهرا","اقبالیه","شریفیه"],
        "قم":["قم","جعفریه","کهک","سلفچگان","دستجرد","قنوات","کوشک نصرت"],
        "کردستان":["سنندج","سقز","مریوان","بانه","قروه","کامیاران","دیواندره","سروآباد"],
        "کرمان":["کرمان","سیرجان","رفسنجان","جیرفت","بم","زرند","کهنوج","بافت","کوهبنان"],
        "کرمانشاه":["کرمانشاه","اسلام‌آباد غرب","کنگاور","سنقر","هرسین","صحنه","جوانرود","قصرشیرین"],
        "کهگیلویه و بویراحمد":["یاسوج","دهدشت","گچساران","لیکک","باشت","چرام","سی‌سخت","سوق"],
        "گلستان":["گرگان","گنبد کاووس","علی‌آباد کتول","بندر ترکمن","آزادشهر","کردکوی","کلاله","مینودشت"],
        "گیلان":["رشت","بندر انزلی","لاهیجان","لنگرود","رودسر","آستارا","صومعه‌سرا","فومن","سیاهکل"],
        "لرستان":["خرم‌آباد","بروجرد","دورود","کوهدشت","الشتر","نورآباد","ازنا","پلدختر"],
        "مازندران":["ساری","بابل","آمل","قائم‌شهر","بهشهر","نوشهر","چالوس","تنکابن","رامسر","بابلسر"],
        "مرکزی":["اراک","ساوه","خمین","محلات","دلیجان","تفرش","آشتیان","شازند"],
        "هرمزگان":["بندرعباس","میناب","دهبارز","قشم","کیش","بندر لنگه","حاجی‌آباد","رودان","جاسک"],
        "همدان":["همدان","ملایر","نهاوند","اسدآباد","تویسرکان","کبودرآهنگ","رزن","بهار"],
        "یزد":["یزد","میبد","اردکان","بافق","مهریز","تفت","ابرکوه","خاتم"]
    };

    const cityNamesEn = {
        "تبریز": "Tabriz", "مراغه": "Maragheh", "مرند": "Marand", "بناب": "Bonab", "میانه": "Meyaneh", "اهر": "Ahar", "سراب": "Sarab", "شبستر": "Shabestar", "اسکو": "Osku", "جلفا": "Jolfa", "هشترود": "Hashtrud", "ارومیه": "Urmia", "خوی": "Khoy", "مهاباد": "Mahabad", "بوکان": "Bukan", "پیرانشهر": "Piranshahr", "میاندوآب": "Miandoab", "سردشت": "Sardasht", "ماکو": "Maku", "نقده": "Naqadeh", "سلماس": "Salmas", "اردبیل": "Ardabil", "پارس‌آباد": "Parsabad", "خلخال": "Khalkhal", "مشگین‌شهر": "Meshginshahr", "نمین": "Namin", "بیله‌سوار": "Bilesavar", "سرعین": "Sareyn", "نیر": "Neyyer", "کوثر": "Kowsar", "اصفهان": "Isfahan", "کاشان": "Kashan", "نجف‌آباد": "Najafabad", "شهرضا": "Shahreza", "مبارکه": "Mobarekeh", "گلپایگان": "Golpayegan", "نطنز": "Natanz", "فولادشهر": "Fouladshahr", "شاهین‌شهر": "Shahinsahr", "فلاورجان": "Falavarjan", "کرج": "Karaj", "طالقان": "Taleqan", "نظرآباد": "Nazarabad", "هشتگرد": "Hashtgerd", "اشتهارد": "Eshtehard", "فردیس": "Fardis", "ماهدشت": "Mahdasht", "کمال‌شهر": "Kamalshahr", "چهارباغ": "Chaharbāgh", "ایلام": "Ilam", "دهلران": "Dehloran", "مهران": "Mehran", "آبدانان": "Abdanan", "ایوان": "Eyvan", "دره‌شهر": "Darreh Shahr", "سرابله": "Sarableh", "بدره": "Badreh", "چرداول": "Chardavol", "بوشهر": "Bushehr", "برازجان": "Borazjan", "کنگان": "Kangan", "جم": "Jam", "گناوه": "Genaveh", "دشتی": "Dashti", "دیر": "Dayyer", "عسلویه": "Asaluyeh", "خارک": "Kharg", "تهران": "Tehran", "شهریار": "Shahriar", "اسلام‌شهر": "Eslamshahr", "ملارد": "Malard", "پاکدشت": "Pakdasht", "ورامین": "Varamin", "دماوند": "Damavand", "ری": "Ray", "شمیرانات": "Shemiranat", "پردیس": "Pardis", "رباط‌کریم": "Robat Karim", "شهرکرد": "Shahrekord", "بروجن": "Borujen", "لردگان": "Lordegan", "فرخشهر": "Farrokh Shahr", "سامان": "Saman", "هفشجان": "Hafshejan", "کیار": "Kiar", "فارسان": "Farsan", "بیرجند": "Birjand", "قائن": "Qaen", "فردوس": "Ferdows", "سرایان": "Sarayan", "طبس": "Tabas", "نهبندان": "Nehbandan", "بشرویه": "Boshruyeh", "سربیشه": "Sarbishé", "مشهد": "Mashhad", "نیشابور": "Nishabur", "سبزوار": "Sabzevar", "تربت‌حیدریه": "Torbat-e Heydarieh", "بردسکن": "Bardaskan", "فریمان": "Fariman", "گناباد": "Gonabad", "قوچان": "Quchan", "کاشمر": "Kashmar", "خواف": "Khaf", "بجنورد": "Bojnord", "شیروان": "Shirvan", "اسفراین": "Esfarayen", "جاجرم": "Jajarm", "مانه": "Maneh", "فاروج": "Faruj", "راز": "Raz", "گرمه": "Garmeh", "اهواز": "Ahvaz", "دزفول": "Dezful", "آبادان": "Abadan", "اندیمشک": "Andimeshk", "خرمشهر": "Khorramshahr", "ماهشهر": "Mahshahr", "بهبهان": "Behbahan", "مسجدسلیمان": "Masjed Soleyman", "ایذه": "Izeh", "شوشتر": "Shushtar", "زنجان": "Zanjan", "ابهر": "Abhar", "خرمدره": "Khorramdarreh", "قیدار": "Qeydar", "هیدج": "Hidaj", "سلطانیه": "Soltaniyeh", "زرین‌رود": "Zarrin Rud", "ماهنشان": "Mahneshan", "سمنان": "Semnan", "شاهرود": "Shahroud", "دامغان": "Damghan", "گرمسار": "Garmsar", "مهدی‌شهر": "Mehdishahr", "آرادان": "Aradan", "سرخه": "Sorkheh", "شهمیرزاد": "Shahmirzad", "زاهدان": "Zahedan", "زابل": "Zabol", "ایرانشهر": "Iranshahr", "چابهار": "Chabahar", "خاش": "Khash", "سراوان": "Saravan", "نیک‌شهر": "Nikshahr", "کنارک": "Konarak", "سرباز": "Sarbaz", "شیراز": "Shiraz", "مرودشت": "Marvdasht", "جهرم": "Jahrom", "فسا": "Fasa", "لار": "Lar", "کازرون": "Kazeroon", "داراب": "Darab", "اقلید": "Eqlid", "فیروزآباد": "Firuzabad", "استهبان": "Estahban", "قزوین": "Qazvin", "تاکستان": "Takestan", "الوند": "Alvand", "محمدیه": "Mohammadieh", "آبیک": "Abyek", "بویین‌زهرا": "Buin Zahra", "اقبالیه": "Iqbalieh", "شریفیه": "Sharifabad", "قم": "Qom", "جعفریه": "Jafariyeh", "کهک": "Kahak", "سلفچگان": "Salafchegan", "دستجرد": "Dastjerd", "قنوات": "Qanavat", "کوشک نصرت": "Kushk-e Nosrat", "سنندج": "Sanandaj", "سقز": "Saqqez", "مریوان": "Marivan", "بانه": "Baneh", "قروه": "Qorveh", "کامیاران": "Kamyaran", "دیواندره": "Divandarreh", "سروآباد": "Sarvabad", "کرمان": "Kerman", "سیرجان": "Sirjan", "رفسنجان": "Rafsanjan", "جیرفت": "Jiroft", "بم": "Bam", "زرند": "Zarand", "کهنوج": "Kahnuj", "بافت": "Baft", "کوهبنان": "Kuhbanan", "کرمانشاه": "Kermanshah", "اسلام‌آباد غرب": "Islamabad-e Gharb", "کنگاور": "Kangavar", "سنقر": "Sonqor", "هرسین": "Harsin", "صحنه": "Sahneh", "جوانرود": "Javanrud", "قصرشیرین": "Qasr-e Shirin", "یاسوج": "Yasuj", "دهدشت": "Dehdasht", "گچساران": "Gachsaran", "لیکک": "Likak", "باشت": "Basht", "چرام": "Charam", "سی‌سخت": "Sisikht", "سوق": "Suq", "گرگان": "Gorgan", "گنبد کاووس": "Gonbad-e Kavus", "علی‌آباد کتول": "Aliabad-e Katul", "بندر ترکمن": "Bandar-e Torkaman", "آزادشهر": "Azadshahr", "کردکوی": "Kordkuy", "کلاله": "Kalaleh", "مینودشت": "Minudasht", "رشت": "Rasht", "بندر انزلی": "Bandar-e Anzali", "لاهیجان": "Lahijan", "لنگرود": "Langerud", "رودسر": "Rudsar", "آستارا": "Astara", "صومعه‌سرا": "Sowme'eh Sara", "فومن": "Fuman", "سیاهکل": "Siahkal", "خرم‌آباد": "Khorramabad", "بروجرد": "Borujerd", "دورود": "Dorud", "کوهدشت": "Kuhdasht", "الشتر": "Alishtar", "نورآباد": "Nurabad", "ازنا": "Azna", "پلدختر": "Pol-e Dokhtar", "ساری": "Sari", "بابل": "Babol", "آمل": "Amol", "قائم‌شهر": "Qaem Shahr", "بهشهر": "Behshahr", "نوشهر": "Nowshahr", "چالوس": "Chalus", "تنکابن": "Tonekabon", "رامسر": "Ramsar", "بابلسر": "Babolsar", "اراک": "Arak", "ساوه": "Saveh", "خمین": "Khomein", "محلات": "Mahallat", "دلیجان": "Delijan", "تفرش": "Tafresh", "آشتیان": "Ashtian", "شازند": "Shazand", "بندرعباس": "Bandar Abbas", "میناب": "Minab", "دهبارز": "Dehbarz", "قشم": "Qeshm", "کیش": "Kish", "بندر لنگه": "Bandar-e Lengeh", "حاجی‌آباد": "Hajiabad", "رودان": "Rudan", "جاسک": "Jask", "همدان": "Hamadan", "ملایر": "Malayer", "نهاوند": "Nahavand", "اسدآباد": "Asadabad", "تویسرکان": "Tuyserkan", "کبودرآهنگ": "Kabudrahang", "رزن": "Razan", "بهار": "Bahar", "یزد": "Yazd", "میبد": "Meybod", "اردکان": "Ardakan", "بافق": "Bafq", "مهریز": "Mahriz", "تفت": "Taft", "ابرکوه": "Abarkuh", "خاتم": "Khatam"
    };

    const provinceCentersEn = {
        "آذربایجان شرقی": "Tabriz", "آذربایجان غربی": "Urmia", "اردبیل": "Ardabil", "اصفهان": "Isfahan", "البرز": "Karaj", "ایلام": "Ilam", "بوشهر": "Bushehr", "تهران": "Tehran", "چهارمحال و بختیاری": "Shahrekord", "خراسان جنوبی": "Birjand", "خراسان رضوی": "Mashhad", "خراسان شمالی": "Bojnord", "خوزستان": "Ahvaz", "زنجان": "Zanjan", "سمنان": "Semnan", "سیستان و بلوچستان": "Zahedan", "فارس": "Shiraz", "قزوین": "Qazvin", "قم": "Qom", "کردستان": "Sanandaj", "کرمان": "Kerman", "کرمانشاه": "Kermanshah", "کهگیلویه و بویراحمد": "Yasuj", "گلستان": "Gorgan", "گیلان": "Rasht", "لرستان": "Khorramabad", "مازندران": "Sari", "مرکزی": "Arak", "هرمزگان": "Bandar Abbas", "همدان": "Hamadan", "یزد": "Yazd"
    };

    // ------------------ مدیریت دراپ‌داون کاستوم ------------------
    const selectWrapper = document.querySelector('.custom-select-wrapper');
    const selectTrigger = document.getElementById('selectTrigger');
    const optionsContainer = document.getElementById('optionsContainer');
    const selectedOptionText = document.getElementById('selectedOptionText');
    const hiddenInput = document.getElementById('citySelect');
    const optionsList = document.getElementById('optionsList');
    const searchInput = document.getElementById('searchInput');

    function populateSelect() {
        optionsList.innerHTML = '';
        for(const province in iranProvinces){
            const optgroupLabel = document.createElement("div");
            optgroupLabel.className = "optgroup-label";
            optgroupLabel.textContent = province;
            optionsList.appendChild(optgroupLabel);
            
            const provinceOption = document.createElement("div");
            provinceOption.className = "custom-option";
            provinceOption.textContent = province;
            provinceOption.setAttribute('data-value', province);
            provinceOption.addEventListener('click', () => {
                selectOption(province);
            });
            optionsList.appendChild(provinceOption);

            iranProvinces[province].forEach(city => {
                const optionDiv = document.createElement("div");
                optionDiv.className = "custom-option";
                optionDiv.textContent = city;
                optionDiv.setAttribute('data-value', city);
                optionDiv.addEventListener('click', () => {
                    selectOption(city);
                });
                optionsList.appendChild(optionDiv);
            });
        }
    }

    function selectOption(city) {
        selectedOptionText.textContent = city;
        hiddenInput.value = city;
        optionsContainer.style.display = 'none';
        const options = document.querySelectorAll('.custom-option');
        options.forEach(option => {
            option.classList.remove('selected');
        });
        const selected = document.querySelector(`[data-value="${city}"]`);
        if (selected) {
            selected.classList.add('selected');
        }
    }

    function searchSelect() {
        const filter = searchInput.value.toLowerCase();
        const options = optionsList.querySelectorAll('.custom-option');
        const labels = optionsList.querySelectorAll('.optgroup-label');

        options.forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(filter)) {
                option.style.display = "";
            } else {
                option.style.display = "none";
            }
        });

        labels.forEach(label => {
            let hasVisibleOptions = false;
            let nextSibling = label.nextElementSibling;
            while(nextSibling && !nextSibling.classList.contains('optgroup-label')) {
                if(nextSibling.style.display !== 'none') {
                    hasVisibleOptions = true;
                    break;
                }
                nextSibling = nextSibling.nextElementSibling;
            }
            if (hasVisibleOptions) {
                label.style.display = "";
            } else {
                label.style.display = "none";
            }
        });
    }

    selectTrigger.addEventListener('click', (event) => {
        event.stopPropagation();
        const isVisible = optionsContainer.style.display === 'block';
        optionsContainer.style.display = isVisible ? 'none' : 'block';
        selectTrigger.querySelector('i').style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
        if(!isVisible) {
            searchInput.focus();
            searchSelect();
        }
    });

    searchInput.addEventListener('input', searchSelect);

    document.addEventListener('click', (e) => {
        if (!selectWrapper.contains(e.target)) {
            optionsContainer.style.display = 'none';
            selectTrigger.querySelector('i').style.transform = 'rotate(0deg)';
        }
    });

    document.addEventListener('DOMContentLoaded', populateSelect);

    // ------------------ API WeatherAPI.com ------------------
    const apiKey ="44fb6b68fd9f41a19a2125317252608"; // کلید API شما

    const weatherIconMap = {
        1000: 'fas fa-sun',
        1003: 'fas fa-cloud-sun',
        1006: 'fas fa-cloud',
        1009: 'fas fa-cloud-meatball',
        1030: 'fas fa-smog',
        1063: 'fas fa-cloud-showers-heavy',
        1066: 'fas fa-snowflake',
        1069: 'fas fa-cloud-showers-heavy',
        1072: 'fas fa-cloud-rain',
        1087: 'fas fa-bolt',
        1114: 'fas fa-snowflake',
        1117: 'fas fa-wind',
        1135: 'fas fa-smog',
        1147: 'fas fa-smog',
        1150: 'fas fa-cloud-rain',
        1153: 'fas fa-cloud-rain',
        1168: 'fas fa-cloud-rain',
        1171: 'fas fa-cloud-rain',
        1180: 'fas fa-cloud-rain',
        1183: 'fas fa-cloud-rain',
        1186: 'fas fa-cloud-showers-heavy',
        1189: 'fas fa-cloud-showers-heavy',
        1192: 'fas fa-cloud-showers-heavy',
        1195: 'fas fa-cloud-showers-heavy',
        1198: 'fas fa-cloud-rain',
        1201: 'fas fa-cloud-showers-heavy',
        1204: 'fas fa-cloud-showers-heavy',
        1207: 'fas fa-cloud-showers-heavy',
        1210: 'fas fa-snowflake',
        1213: 'fas fa-snowflake',
        1216: 'fas fa-snowflake',
        1219: 'fas fa-snowflake',
        1222: 'fas fa-snowflake',
        1225: 'fas fa-snowflake',
        1237: 'fas fa-cloud-showers-heavy',
        1240: 'fas fa-cloud-rain',
        1243: 'fas fa-cloud-showers-heavy',
        1246: 'fas fa-cloud-showers-heavy',
        1249: 'fas fa-cloud-showers-heavy',
        1252: 'fas fa-cloud-showers-heavy',
        1255: 'fas fa-snowflake',
        1258: 'fas fa-snowflake',
        1261: 'fas fa-cloud-rain',
        1264: 'fas fa-cloud-showers-heavy',
        1273: 'fas fa-bolt',
        1276: 'fas fa-bolt',
        1279: 'fas fa-bolt',
        1282: 'fas fa-bolt',
    };
    
    function getWeatherBgClass(conditionText) {
        const condition = conditionText.toLowerCase();
        if (condition.includes('آفتابی') || condition.includes('صاف')) return 'bg-gradient-to-br from-yellow-100 to-yellow-300';
        if (condition.includes('ابری') || condition.includes('نیمه ابری')) return 'bg-gradient-to-br from-gray-100 to-gray-300';
        if (condition.includes('بارانی') || condition.includes('باران') || condition.includes('رگبار')) return 'bg-gradient-to-br from-blue-200 to-blue-400';
        if (condition.includes('برفی') || condition.includes('برف')) return 'bg-gradient-to-br from-white to-blue-100';
        if (condition.includes('مه')) return 'bg-gradient-to-br from-gray-200 to-gray-400';
        if (condition.includes('رعد و برق') || condition.includes('تندر')) return 'bg-gradient-to-br from-slate-300 to-slate-500';
        return 'bg-white';
    }

    function getWeatherIconColor(conditionText) {
        const condition = conditionText.toLowerCase();
        if (condition.includes('آفتابی') || condition.includes('صاف')) return 'text-yellow-500';
        if (condition.includes('بارانی') || condition.includes('باران')) return 'text-blue-600';
        if (condition.includes('برفی') || condition.includes('برف')) return 'text-sky-300';
        if (condition.includes('ابری') || condition.includes('نیمه ابری')) return 'text-gray-500';
        return 'text-blue-600';
    }

    async function getWeather(){
        const selectedFaName = document.getElementById("citySelect").value;
        if(!selectedFaName) { alert("لطفا یک شهر یا استان را انتخاب کنید."); return; }

        let cityEn;
        if (provinceCentersEn[selectedFaName]) {
            cityEn = provinceCentersEn[selectedFaName];
        } else {
            cityEn = cityNamesEn[selectedFaName] || selectedFaName;
        }

        const weatherResultDiv = document.getElementById("weatherResult");
        const currentWeatherDiv = document.getElementById("currentWeather");
        const forecastDiv = document.getElementById("forecast");

        currentWeatherDiv.innerHTML = `<div class="text-center w-full"><i class="fas fa-spinner fa-spin text-5xl text-blue-500"></i><p class="mt-4 text-xl text-gray-600">در حال بارگذاری...</p></div>`;
        forecastDiv.innerHTML = '';
        weatherResultDiv.classList.remove('hidden');
        setTimeout(() => { weatherResultDiv.classList.remove('opacity-0'); }, 10);

        try {
            const weatherApiUrl = `https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=${cityEn}&lang=fa`;
            const forecastApiUrl = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${cityEn}&days=5&lang=fa`;

            const [weatherRes, forecastRes] = await Promise.all([
                fetch(weatherApiUrl),
                fetch(forecastApiUrl)
            ]);

            if (!weatherRes.ok || !forecastRes.ok) {
                const errorData = await weatherRes.json();
                throw new Error(`خطا در دریافت اطلاعات: ${errorData.error.message}`);
            }

            const weatherData = await weatherRes.json();
            const forecastData = await forecastRes.json();

            const weatherConditionCode = weatherData.current.condition.code;
            const weatherConditionFa = weatherData.current.condition.text;
            const weatherIconClass = weatherIconMap[weatherConditionCode] || 'fas fa-question-circle';
            const weatherBgClass = getWeatherBgClass(weatherConditionFa);
            const weatherIconColor = getWeatherIconColor(weatherConditionFa);

            currentWeatherDiv.className = `weather-card p-8 rounded-3xl shadow-xl mb-8 flex flex-col sm:flex-row justify-around items-center space-y-6 sm:space-y-0 text-center relative ${weatherBgClass}`;

            currentWeatherDiv.innerHTML = `
                <div class="flex flex-col items-center">
                    <i class="${weatherIconClass} text-8xl ${weatherIconColor} drop-shadow-lg"></i>
                    <div class="mt-4 text-center">
                        <p class="text-5xl font-extrabold text-blue-800">${weatherData.current.temp_c.toFixed(1)}°C</p>
                        <p class="text-lg text-gray-700">دما</p>
                    </div>
                </div>
                <div class="flex flex-col items-center">
                    <i class="fas fa-smog text-6xl text-gray-500"></i>
                    <div class="mt-2 text-center">
                        <p class="text-xl font-semibold capitalize text-gray-800">${weatherConditionFa}</p>
                        <p class="text-sm text-gray-600">وضعیت</p>
                    </div>
                </div>
                <div class="flex flex-col items-center">
                    <i class="fas fa-tint text-6xl text-blue-400"></i>
                    <div class="mt-2 text-center">
                        <p class="text-4xl font-bold text-gray-800">${weatherData.current.humidity}%</p>
                        <p class="text-sm text-gray-600">رطوبت</p>
                    </div>
                </div>
                <div class="flex flex-col items-center">
                    <i class="fas fa-wind text-6xl text-gray-400"></i>
                    <div class="mt-2 text-center">
                        <p class="text-4xl font-bold text-gray-800">${weatherData.current.wind_kph.toFixed(1)} km/h</p>
                        <p class="text-sm text-gray-600">سرعت باد</p>
                    </div>
                </div>`;

            const dailyForecast = forecastData.forecast.forecastday.slice(0, 5);
            forecastDiv.innerHTML = dailyForecast.map(day => {
                const date = new Date(day.date);
                const dayName = date.toLocaleDateString('fa-IR', { weekday: 'short' });
                const formattedDate = date.toLocaleDateString('fa-IR', { day: 'numeric', month: 'numeric' });
                const forecastIconClass = weatherIconMap[day.day.condition.code] || 'fas fa-question-circle';
                const forecastIconColor = getWeatherIconColor(day.day.condition.text);
                return `
                    <div class="forecast-card shadow-lg rounded-2xl p-6 text-center flex flex-col items-center">
                        <p class="font-bold text-lg text-gray-800">${dayName}</p>
                        <p class="text-sm text-gray-500">${formattedDate}</p>
                        <i class="${forecastIconClass} text-5xl ${forecastIconColor} my-4"></i>
                        <p class="text-2xl font-bold my-2 text-blue-800">${day.day.avgtemp_c.toFixed(1)}°C</p>
                        <p class="text-sm capitalize text-gray-600">${day.day.condition.text}</p>
                    </div>`;
            }).join("");
        } catch (err) {
            currentWeatherDiv.innerHTML = `<div class="text-center w-full text-red-600"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p class="text-lg">خطا در دریافت اطلاعات: ${err.message}</p><p class="text-sm mt-2">لطفا از صحت نام شهر و کلید API خود اطمینان حاصل کنید.</p></div>`;
            forecastDiv.innerHTML = '';
            console.error(err);
        }
    }

    // ------------------ کامنت‌ها ------------------
    function loadComments(){
        const comments = JSON.parse(localStorage.getItem("comments")||"[]");
        const list = document.getElementById("commentsList");
        list.innerHTML="";
        comments.forEach((c,i)=>{
            const div = document.createElement("div");
            div.className="comment-item p-4 rounded-xl shadow-md flex justify-between items-center";
            div.innerHTML=`<span class="flex-grow ml-3 text-gray-800">${c.comment}</span>
                                 <button onclick="deleteComment(${i})" class="text-gray-400 hover:text-red-500 transition duration-300"><i class="fas fa-trash-alt"></i></button>`;
            list.appendChild(div);
        });
    }
    function addComment(){
        const input=document.getElementById("commentInput");
        const txt=input.value.trim();
        if(!txt) { alert("لطفا نظر خود را وارد کنید."); return; }
        const comments=JSON.parse(localStorage.getItem("comments")||"[]");
        comments.push({comment:txt, date:new Date().toISOString()});
        localStorage.setItem("comments",JSON.stringify(comments));
        input.value="";
        loadComments();
    }
    function deleteComment(index){
        const comments=JSON.parse(localStorage.getItem("comments")||"[]");
        comments.splice(index,1);
        localStorage.setItem("comments",JSON.stringify(comments));
        loadComments();
    }
    window.addEventListener('load', loadComments);
</script>
</body>
</html>
